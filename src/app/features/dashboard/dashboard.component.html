<section class="dashboard-shell" [class.map-view]="activeView === 'map'">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">
        <img src="https://images.unsplash.com/photo-1503023345310-bd7c1de61c7d?auto=format&fit=crop&w=200&q=60" alt="Company logo" />
      </div>
      <div class="brand-copy">
        <p class="eyebrow">Company Name</p>
        <strong>Stand Seller</strong>
      </div>
    </div>

    <nav class="sidebar-nav">
      @for (item of sidebarNav; track item.label) {
        <button type="button" class="nav-link" [class.active]="isNavItemActive(item)" (click)="handleSidebarNavClick(item)">
          <span class="icon">
            <svg viewBox="0 0 24 24" role="presentation">
              <ng-container [ngSwitch]="item.icon">
                <path *ngSwitchCase="'dashboard'" d="M3 3h8v8H3V3zm10 0h8v6h-8V3zM3 13h8v8H3v-8zm10-4h8v12h-8V9z" />
                <path *ngSwitchCase="'stands'" d="m4 9 8-5 8 5v10H4V9zm8-2.5-5 3.1V17h10v-7.4l-5-3.1z" />
                <path *ngSwitchCase="'buyers'" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4 0-7 2-7 4v2h14v-2c0-2-3-4-7-4z" />
                <path *ngSwitchCase="'payements'" d="M5 5h14v2H5zm0 6h14v2H5zm0 6h14v2H5z" />
                <path *ngSwitchCase="'reports'" d="M6 20V10h2v10zm5 0V4h2v16zm5 0v-6h2v6z" />
                <path *ngSwitchCase="'map'" d="M4 5h16v14H4zm2 2v10h12V7z" />
                <path *ngSwitchCase="'settings'" d="m12 8 1.1-2.1 2.2-.4.5-2.5 2.1.7 1.4 2-1.5 2 1.5 2-1.4 2-2.1.7-.5-2.5-2.2-.4L12 8l-1.1 2.1-2.2.4-.5 2.5-2.1-.7-1.4-2 1.5-2-1.5-2 1.4-2 2.1-.7.5 2.5 2.2.4z" />
                <path *ngSwitchDefault d="M5 11h14v2H5z" />
              </ng-container>
            </svg>
          </span>
          <span>{{ item.label }}</span>
          @if (item.label === 'Stands') {
            <span class="badge">{{ availableStandsCount() }}</span>
          } @else if (item.badge) {
            <span class="badge">{{ item.badge }}</span>
          }
        </button>
      }
    </nav>

    <div class="sidebar-card logout-card">
      <button type="button" class="logout-button" (click)="handleLogout()">
        <span>Log out</span>
        <svg viewBox="0 0 24 24" role="presentation" aria-hidden="true">
          <path d="M16 13v-2H7V8l-5 4 5 4v-3zm3-10H8a2 2 0 0 0-2 2v4h2V5h11v14H8v-4H6v4a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" />
        </svg>
      </button>
    </div>
  </aside>

  <div
    class="main-panel"
    [class.map-active]="activeView === 'map'"
    [class.settings-view]="activeView === 'settings'">
    <header class="main-header">
      <div>
        @if (activeView === 'dashboard') {
          <p class="eyebrow">Dashboard</p>
          <h1>Stand Management</h1>
          <p class="helper">Monitor stands, orders, and payments in one place.</p>
        } @else if (activeView === 'map') {
          <p class="eyebrow">Map</p>
          <h1>Stand Map</h1>
          <p class="helper">View all stands and their availability status.</p>
        } @else if (activeView === 'stands') {
          <p class="eyebrow">Stands</p>
          <h1>Available Stands</h1>
          <p class="helper">Showing {{ availableStandsCount() }} stands currently available.</p>
        } @else {
          <p class="eyebrow">Account</p>
          <h1>Profile &amp; Settings</h1>
          <p class="helper">Review and maintain your personal information.</p>
        }
      </div>
      <div class="header-tools">
        @if (activeView === 'stands') {
          <form class="stand-search__form" (ngSubmit)="handleStandSearch($event)" novalidate>
            <label>
              <span class="sr-only">Stand ID</span>
              <input
                type="text"
                name="standSearchTerm"
                placeholder="Search stand ID..."
                [(ngModel)]="standSearchTerm"
                [disabled]="searchingStand"
              />
            </label>
            <button type="submit" [disabled]="searchingStand || !standSearchTerm.trim()">Search</button>
            @if (standSearchTerm || standSearchResult || standSearchError) {
              <button type="button" class="ghost" (click)="clearStandSearch()">Clear</button>
            }
          </form>
        }
        <button type="button" class="icon-button" aria-label="Notifications">
          <svg viewBox="0 0 24 24" role="presentation">
            <path d="M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2zm8-6v-5a8 8 0 0 0-6-7.75V2a2 2 0 0 0-4 0v1.25A8 8 0 0 0 4 11v5l-2 2v1h20v-1l-2-2z" />
          </svg>
        </button>
        <div class="profile-menu" #profileMenu [class.open]="isUserMenuOpen">
          <button
            type="button"
            class="avatar-button"
            [class.active]="isUserMenuOpen || activeView === 'settings'"
            (click)="toggleUserMenu($event)"
            aria-haspopup="menu"
            [attr.aria-expanded]="isUserMenuOpen"
          >
            <span class="avatar">
              <img [src]="userProfile.avatarUrl" [alt]="userProfile.firstName + ' ' + userProfile.lastName" />
            </span>
            <span class="user-meta">
              <strong>{{ userInitials }}</strong>
              <span>{{ userProfile.role }}</span>
            </span>
          </button>
          <div class="user-menu" role="menu">
            <button type="button" role="menuitem" (click)="handleUserMenuSelect('settings')">Settings</button>
            <button type="button" role="menuitem" (click)="handleUserMenuSelect('logout')">Logout</button>
          </div>
        </div>
      </div>
    </header>

    @if (activeView === 'map') {
      <section class="map-layout">
        @if (loadingStands()) {
          <div class="loading-state">
            <p>Loading stands...</p>
          </div>
        } @else {
          <div class="map-container">
            <div class="map-header">
              <h2 class="map-title">Downtown Avenue</h2>
            </div>
            <div class="stands-grid">
              @for (stand of stands(); track stand.id) {
                <div class="stand-card" [class.sold]="isStandSold(stand)" [class.available]="!isStandSold(stand)">
                  <div class="stand-info">
                    <p class="stand-name">{{ stand.name || 'Plot 21 - City Center' }}</p>
                    <div class="stand-number" [class.sold-text]="isStandSold(stand)">
                      @if (isStandSold(stand)) {
                        <strong>SOLD</strong>
                      } @else {
                        <strong>{{ getStandNumber(stand) ?? 'null' }}</strong>
                      }
                    </div>
                    <p class="stand-status" [class.sold-text]="isStandSold(stand)">
                      {{ isStandSold(stand) ? 'sold' : 'available' }}
                    </p>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </section>
    } @else if (activeView === 'stands') {
      <section class="stands-view">
        <header class="stands-view__header">
          <div>
            <p class="eyebrow">Inventory</p>
            <h2>{{ availableStandsCount() }} stands available</h2>
            <p class="helper">Only stands with status “available” are listed here.</p>
            @if (standSearchError) {
              <p class="stand-search__error">{{ standSearchError }}</p>
            }
          </div>
          <button type="button" class="ghost primary" (click)="openAddStandModal()" [disabled]="loadingStands()">Add stand</button>
        </header>

        @if (loadingStands()) {
          <div class="loading-state">
            <p>Loading stands...</p>
          </div>
        } @else {
          @if (standSearchResult) {
            <div class="search-result-card">
              <div class="search-result-card__header">
                <div>
                  <p class="eyebrow">Search result</p>
                  <h3>{{ standSearchResult.name || 'Untitled stand' }}</h3>
                </div>
                <span class="pill" [class.available-pill]="isStandAvailable(standSearchResult)">
                  {{ standSearchResult.status | titlecase }}
                </span>
              </div>
              <dl class="stand-meta">
                <div>
                  <dt>Stand ID</dt>
                  <dd>{{ standSearchResult.id }}</dd>
                </div>
                <div>
                  <dt>Stand No.</dt>
                  <dd>{{ getStandNumber(standSearchResult) ?? '—' }}</dd>
                </div>
                <div>
                  <dt>Type</dt>
                  <dd>{{ standSearchResult.type || '—' }}</dd>
                </div>
                <div>
                  <dt>Location</dt>
                  <dd>{{ standSearchResult.location || '—' }}</dd>
                </div>
              </dl>
              <footer class="stand-card__footer">
                <span>Last updated {{ formatDate(standSearchResult.updatedAt) }}</span>
              </footer>
            </div>
          }

          @if (getAvailableStands().length) {
            <div class="stands-collection">
              @for (stand of getAvailableStands(); track stand.id) {
                <article class="stand-card available stand-card--details">
                  <header class="stand-card__header">
                    <div>
                      <p class="stand-name">{{ stand.name || 'Unnamed Stand' }}</p>
                      <span class="stand-location">{{ stand.location || '—' }}</span>
                    </div>
                    <span class="stand-number">
                      <strong>{{ getStandNumber(stand) ?? '—' }}</strong>
                    </span>
                  </header>
                  <dl class="stand-meta">
                    <div>
                      <dt>Type</dt>
                      <dd>{{ stand.type || '—' }}</dd>
                    </div>
                    <div>
                      <dt>Price</dt>
                      <dd>{{ stand.price | currency: 'USD' : 'symbol' : '1.0-0' }}</dd>
                    </div>
                    <div>
                      <dt>Size</dt>
                      <dd>{{ stand.size ? stand.size + ' sqm' : '—' }}</dd>
                    </div>
                  </dl>
                  <footer class="stand-card__footer">
                    <span>Updated {{ formatDate(stand.updatedAt) }}</span>
                  </footer>
                </article>
              }
            </div>
          } @else {
            <div class="empty-state">
              <h3>No available stands</h3>
              <p>All stands are currently allocated. Check back later or refresh.</p>
            </div>
          }
        }
      </section>
    } @else if (activeView === 'dashboard') {
      <section class="analytics-grid">
        <article class="panel today-sales">
          <header>
            <div>
              <p class="eyebrow">Today's Sales</p>
              <h2>Sales Summary</h2>
            </div>
            <button type="button" class="ghost">Export</button>
          </header>

          <div class="sales-cards">
            @for (card of salesSummaryCards; track card.label) {
              <article class="summary-card" [ngClass]="'accent-' + card.accent">
                <p class="eyebrow">{{ card.label }}</p>
                <strong>{{ card.value }}</strong>
                <span>{{ card.helper }}</span>
              </article>
            }
          </div>
        </article>

        <article class="panel visitor-panel">
          <header>
            <p class="eyebrow">Visitor Insights</p>
            <span class="helper">Customers · Leads · Unique</span>
          </header>
          <div class="visitor-chart">
            <svg viewBox="0 0 100 100" preserveAspectRatio="none">
              @for (series of visitorInsights.series; track series.name) {
                <polyline
                  [attr.points]="buildLinePoints(series.points)"
                  [attr.stroke]="series.color"
                  fill="none"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                ></polyline>
                @for (value of series.points; track $index; let i = $index) {
                  <circle
                    [attr.cx]="getLineX(i, series.points.length)"
                    [attr.cy]="getLineY(value)"
                    r="1.5"
                    [attr.fill]="series.color"
                  ></circle>
                }
              }
            </svg>
          </div>
          <div class="chart-legend">
            @for (series of visitorInsights.series; track series.name) {
              <span>
                <span class="dot" [style.background]="series.color"></span>
                {{ series.name }}
              </span>
            }
          </div>
        </article>
      </section>

    } @else {
      <section class="settings-layout">
        <article class="profile-showcase">
          <div class="profile-showcase__photo">
            <img [src]="userProfile.avatarUrl" [alt]="userProfile.firstName + ' ' + userProfile.lastName" />
          </div>

          <div class="profile-showcase__details">

            <dl class="info-stack">
              <div class="info-row">
                <dt>Name</dt>
                <dd>{{ userProfile.firstName }} {{ userProfile.lastName }}</dd>
              </div>
              <div class="info-row email-row">
                <dt>Email</dt>
                <dd>{{ userProfile.email | lowercase }}</dd>
              </div>
              <div class="info-row">
                <dt>Cell</dt>
                <dd>{{ userProfile.phoneNumber }}</dd>
              </div>
              <div class="info-row">
                <dt>Role</dt>
                <dd>{{ userProfile.role | titlecase }}</dd>
              </div>
              <div class="info-row">
                <dt>National ID</dt>
                <dd>{{ userProfile.nationalIdentityNumber || '—' }}</dd>
              </div>
              <div class="info-row">
                <dt>Date of Birth</dt>
                <dd>{{ userProfile.dateOfBirth ? (userProfile.dateOfBirth | date: 'mediumDate') : '—' }}</dd>
              </div>
            </dl>

            <div class="cta-row">
              <button type="button" class="pill-button update-button" (click)="handleUpdateProfile()">Update information</button>
            </div>
          </div>
        </article>
      </section>
    }

  </div>
</section>

@if (isUpdateProfileModalOpen()) {
  <app-update-profile-modal
    (close)="handleCloseUpdateProfileModal()"
    (profileUpdated)="handleProfileUpdated()"
  ></app-update-profile-modal>
}

@if (isAddStandModalOpen()) {
  <div class="modal-backdrop" (click)="closeAddStandModal()"></div>
  <section class="modal add-stand-modal" (click)="$event.stopPropagation()">
    <header class="add-stand-modal__header">
      <div>
        <p class="eyebrow">Inventory</p>
        <h2>Add stand</h2>
      </div>
      <button type="button" class="icon-button ghost" aria-label="Close" (click)="closeAddStandModal()">
        <svg viewBox="0 0 24 24" role="presentation">
          <path d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3l6.3 6.3 6.3-6.3z" />
        </svg>
      </button>
    </header>

    <div class="add-stand-tabs">
      <button type="button" [class.active]="addStandMode === 'single'" (click)="setAddStandMode('single')">Single stand</button>
      <button type="button" [class.active]="addStandMode === 'bulk'" (click)="setAddStandMode('bulk')">CSV / Excel upload</button>
    </div>

    @if (addStandMode === 'single') {
      <form class="add-stand-form" (ngSubmit)="handleSingleStandSubmit($event)" novalidate>
        <div class="form-grid">
          <label>
            <span>Name</span>
            <input type="text" name="standName" [(ngModel)]="singleStandForm.name" required />
          </label>
          <label>
            <span>Stand number</span>
            <input type="text" name="standNumber" [(ngModel)]="singleStandForm.standNumber" required />
          </label>
          <label>
            <span>Type</span>
            <input type="text" name="standType" [(ngModel)]="singleStandForm.type" required />
          </label>
          <label>
            <span>Price</span>
            <input type="number" name="standPrice" [(ngModel)]="singleStandForm.price" required min="0" step="0.01" />
          </label>
          <label>
            <span>Size (sqm)</span>
            <input type="number" name="standSize" [(ngModel)]="singleStandForm.size" required min="0" step="0.01" />
          </label>
          <label>
            <span>Location</span>
            <input type="text" name="standLocation" [(ngModel)]="singleStandForm.location" required />
          </label>
          <label>
            <span>Status</span>
            <select name="standStatus" [(ngModel)]="singleStandForm.status">
              <option value="available">Available</option>
              <option value="reserved">Reserved</option>
              <option value="sold">Sold</option>
            </select>
          </label>
        </div>
        <label>
          <span>Description</span>
          <textarea name="standDescription" rows="3" [(ngModel)]="singleStandForm.description"></textarea>
        </label>

        @if (singleStandError) {
          <p class="form-feedback error">{{ singleStandError }}</p>
        }
        @if (singleStandSuccess) {
          <p class="form-feedback success">{{ singleStandSuccess }}</p>
        }

        <div class="form-actions">
          <button type="button" class="ghost" (click)="closeAddStandModal()">Cancel</button>
          <button type="submit" class="primary" [disabled]="singleStandSubmitting">
            {{ singleStandSubmitting ? 'Saving…' : 'Save stand' }}
          </button>
        </div>
      </form>
    } @else {
      <form class="add-stand-form" (ngSubmit)="handleBulkUpload($event)" novalidate>
        <label class="file-upload">
          <span>Upload CSV/XLSX</span>
          <input
            type="file"
            name="bulkStandFile"
            accept=".csv,.xlsx,.xls"
            (change)="handleBulkFileSelected($event)"
            #bulkFileInput
          />
        </label>
        @if (bulkUploadError) {
          <p class="form-feedback error">{{ bulkUploadError }}</p>
        }
        @if (bulkUploadSuccess) {
          <p class="form-feedback success">{{ bulkUploadSuccess }}</p>
        }
        <p class="helper">
          Make sure your file includes columns like name, standNumber, type, price, size, location, status, and description.
        </p>
        <div class="form-actions">
          <button type="button" class="ghost" (click)="closeAddStandModal()">Cancel</button>
          <button type="submit" class="primary" [disabled]="bulkUploading">
            {{ bulkUploading ? 'Uploading…' : 'Upload file' }}
          </button>
        </div>
      </form>
    }
  </section>
}
